<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cestovn√≠ pl√°novaƒç</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- LZString pro kompresi URL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <!-- html2canvas pro export PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Ace Editor pro JSON editaci -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-json.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-tomorrow.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #E07A5F;
            --primary-light: #F2CC8F;
            --primary-dark: #C45D45;
            --secondary: #3D405B;
            --accent: #81B29A;
            --bg-main: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-subtle: #F5F5F5;
            --text-primary: #2D3142;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border: #E5E7EB;
            --error: #DC2626;
            --error-light: #FEE2E2;
            --success: #059669;
            --success-light: #D1FAE5;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.03);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.08), 0 10px 10px -5px rgba(0,0,0,0.02);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }

        .sidebar {
            width: 380px;
            background: var(--bg-card);
            overflow-y: auto;
            padding: 24px 20px;
            border-left: 1px solid var(--border);
            box-shadow: -4px 0 20px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .header {
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 .emoji {
            font-size: 1.3rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 400;
        }

        /* Akƒçn√≠ tlaƒç√≠tka v horn√≠ ƒç√°sti sidebaru */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 100px;
            padding: 8px 12px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: inherit;
        }

        .action-btn:hover {
            background: var(--bg-card);
            border-color: var(--primary);
            color: var(--primary);
        }

        .controls {
            margin-bottom: 16px;
            padding: 12px 14px;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .control-item:last-child {
            margin-bottom: 0;
        }

        .control-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .control-item label {
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .control-item label:hover {
            color: var(--text-primary);
        }

        .timeline {
            position: relative;
            margin-bottom: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--accent) 50%, var(--primary-light) 100%);
            border-radius: 2px;
            z-index: 0;
        }

        .stop {
            position: relative;
            padding: 10px 12px 10px 44px;
            margin-bottom: 6px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            z-index: 1;
        }

        .stop:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
            transform: translateX(2px);
        }

        .stop.active {
            background: var(--bg-card);
            border-color: var(--primary);
            box-shadow: var(--shadow-md), 0 0 0 2px rgba(224, 122, 95, 0.15);
        }

        .stop-number {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
            color: white;
            z-index: 2;
            box-shadow: 0 1px 3px rgba(224, 122, 95, 0.3);
        }

        .stop-type-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .stop-type-badge.start {
            background: var(--success-light);
            color: var(--success);
        }

        .stop-type-badge.cil {
            background: var(--error-light);
            color: var(--error);
        }

        .stop-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .stop-dates {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 500;
        }

        .stop-nights {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: inline;
            margin-left: 8px;
        }

        .stop-notes {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border);
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .notes-icon {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .stats {
            padding: 16px;
            background: linear-gradient(135deg, var(--bg-subtle) 0%, rgba(129, 178, 154, 0.08) 100%);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .stats h3 {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats h3 .emoji {
            font-size: 0.9rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            padding: 6px 0;
        }

        .stat-row:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .modal-header p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 20px 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        /* Error messages */
        .error-summary {
            background: var(--error-light);
            border: 1px solid var(--error);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            margin-bottom: 16px;
            display: none;
        }

        .error-summary.visible {
            display: block;
        }

        .error-summary h4 {
            color: var(--error);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .error-summary ul {
            margin: 0;
            padding-left: 20px;
            font-size: 0.8rem;
            color: var(--error);
        }

        .error-summary li {
            margin-bottom: 4px;
        }

        /* Ace Editor container */
        .ace-editor-container {
            width: 100%;
            height: 300px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            transition: border-color 0.2s ease;
        }

        .ace-editor-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
        }

        .ace-editor-container.has-error {
            border-color: var(--error);
        }

        .ace-editor-container.tall {
            height: 400px;
        }

        /* File drop zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(224, 122, 95, 0.05);
        }

        .drop-zone-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .drop-zone-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .drop-zone-subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .file-input {
            display: none;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-subtle);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--text-muted);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Notification toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--secondary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 10001;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Recovery modal content */
        .recovery-info {
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-bottom: 16px;
        }

        .recovery-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .recovery-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Custom popup styles */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            padding: 0;
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .leaflet-popup-content {
            margin: 14px 16px 14px 16px;
            font-family: 'Inter', sans-serif;
            line-height: 1.4;
            padding-right: 16px;
        }

        .popup-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            padding-right: 8px;
        }

        .popup-dates {
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .popup-nights {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .leaflet-popup-close-button {
            color: var(--text-muted) !important;
            font-size: 16px !important;
            width: 22px !important;
            height: 22px !important;
            padding: 0 !important;
            top: 8px !important;
            right: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.15s ease !important;
            line-height: 1 !important;
        }

        .leaflet-popup-close-button:hover {
            color: var(--text-primary) !important;
            background: var(--bg-subtle) !important;
        }

        /* Map controls styling */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: var(--shadow-lg) !important;
        }

        .leaflet-control-zoom a {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border: none !important;
            width: 32px !important;
            height: 32px !important;
            line-height: 32px !important;
            font-size: 16px !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--bg-subtle) !important;
        }

        .leaflet-control-zoom-in {
            border-radius: var(--radius-sm) var(--radius-sm) 0 0 !important;
        }

        .leaflet-control-zoom-out {
            border-radius: 0 0 var(--radius-sm) var(--radius-sm) !important;
        }

        .leaflet-control-attribution {
            background: rgba(255,255,255,0.9) !important;
            padding: 3px 8px !important;
            font-size: 9px !important;
            border-radius: var(--radius-sm) 0 0 0 !important;
        }

        /* Fix pro popisky na mapƒõ */
        .map-label-container {
            background: transparent !important;
            border: none !important;
            width: auto !important;
            height: auto !important;
        }

        .map-label {
            background: transparent !important;
            border: none !important;
            width: auto !important;
            height: auto !important;
        }

        /* Mobiln√≠ tlaƒç√≠tko pro p≈ôep√≠n√°n√≠ */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 24px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            font-family: inherit;
        }

        /* Responzivn√≠ layout */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                position: relative;
            }

            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                border-left: none;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                z-index: 500;
            }

            .sidebar.visible {
                transform: translateX(0);
            }

            #map {
                width: 100%;
                height: 100%;
            }

            h1 {
                font-size: 1.25rem;
            }

            .mobile-toggle {
                display: block;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                min-width: auto;
            }
        }

        /* Skryt√Ω stav aplikace p≈ôed naƒçten√≠m */
        .app-hidden {
            display: none !important;
        }

        /* Export dropdown */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            z-index: 100;
            margin-top: 4px;
            overflow: hidden;
        }

        .dropdown.open .dropdown-content {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 12px;
            background: none;
            border: none;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .dropdown-item:hover {
            background: var(--bg-subtle);
            color: var(--primary);
        }

        .dropdown-item:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        /* Warning message */
        .warning-message {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-size: 0.75rem;
            color: #92400E;
            margin-top: 8px;
        }

        /* Uk√°zkov√Ω JSON */
        .example-json {
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            overflow-x: auto;
            margin-top: 12px;
            border: 1px solid var(--border);
        }

        .example-json pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .example-toggle {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0;
            margin-top: 12px;
            font-family: inherit;
        }

        .example-toggle:hover {
            text-decoration: underline;
        }

        /* =====================
           Visual Editor Styles
           ===================== */

        /* Tab switcher */
        .editor-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .editor-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: calc(var(--radius-sm) - 2px);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .editor-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.5);
        }

        .editor-tab.active {
            background: var(--bg-card);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .editor-tab svg {
            flex-shrink: 0;
        }

        /* Form sections */
        .form-section {
            margin-bottom: 20px;
        }

        .form-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .form-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 12px 0;
        }

        .form-section-header .form-section-title {
            margin: 0;
        }

        /* Form inputs */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: inherit;
            color: var(--text-primary);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(224, 122, 95, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input.has-error {
            border-color: var(--error);
        }

        .form-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: end;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        /* Visual editor statistics */
        .visual-editor-stats {
            display: flex;
            gap: 16px;
            padding: 10px 14px;
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 0.8rem;
        }

        .visual-editor-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .visual-editor-stat strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Add stop button */
        .btn-add-stop {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .btn-add-stop:hover {
            background: #6a9a82;
        }

        /* Stops list */
        .stops-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stops-list-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
            font-size: 0.875rem;
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
        }

        /* Stop item (accordion) */
        .stop-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }

        .stop-item:hover {
            border-color: var(--primary-light);
        }

        .stop-item.expanded {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .stop-item.dragging {
            opacity: 0.5;
            box-shadow: var(--shadow-lg);
        }

        .stop-item.drag-over {
            border-color: var(--primary);
            border-style: dashed;
        }

        .stop-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            cursor: pointer;
            user-select: none;
        }

        .stop-item-drag-handle {
            color: var(--text-muted);
            cursor: grab;
            padding: 4px;
            margin: -4px;
            display: flex;
            align-items: center;
        }

        .stop-item-drag-handle:active {
            cursor: grabbing;
        }

        .stop-item-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .stop-item:first-child .stop-item-number {
            background: var(--success);
        }

        .stop-item:last-child:not(:first-child) .stop-item-number {
            background: var(--error);
        }

        .stop-item-info {
            flex: 1;
            min-width: 0;
        }

        .stop-item-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stop-item-title.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .stop-item-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .stop-item-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .stop-item-status.complete {
            background: var(--success);
        }

        .stop-item-status.incomplete {
            background: var(--error);
        }

        .stop-item-actions {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .stop-item-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .stop-item-btn:hover {
            background: var(--bg-subtle);
            color: var(--text-primary);
        }

        .stop-item-btn.delete:hover {
            background: var(--error-light);
            color: var(--error);
        }

        .stop-item-toggle svg {
            transition: transform 0.15s ease;
        }

        .stop-item.expanded .stop-item-toggle svg {
            transform: rotate(180deg);
        }

        /* Mobile reorder buttons */
        .stop-item-reorder {
            display: none;
            flex-direction: column;
            gap: 2px;
        }

        .stop-item-reorder .stop-item-btn {
            width: 24px;
            height: 20px;
        }

        @media (max-width: 900px) {
            .stop-item-drag-handle {
                display: none;
            }
            .stop-item-reorder {
                display: flex;
            }
        }

        .stop-item-content {
            padding: 0 14px 14px 14px;
            border-top: 1px solid var(--border);
        }

        .stop-item-content[hidden] {
            display: none;
        }

        .stop-item-content .form-group:first-child {
            margin-top: 14px;
        }

        /* Coordinates row with map picker */
        .coords-row {
            display: grid;
            grid-template-columns: 1fr 1fr 42px;
            gap: 12px;
            align-items: end;
        }

        .coords-row .form-group {
            margin-bottom: 0;
        }

        .btn-map-picker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
            margin-bottom: 0;
        }

        .btn-map-picker:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Markdown preview toggle */
        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
            margin-bottom: 6px;
        }

        .notes-header label {
            margin-bottom: 0 !important;
        }

        .btn-preview-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .btn-preview-toggle:hover,
        .btn-preview-toggle.active {
            background: var(--bg-subtle);
            color: var(--text-secondary);
            border-color: var(--text-muted);
        }

        .markdown-preview {
            padding: 10px 12px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            min-height: 60px;
        }

        .markdown-preview p {
            margin: 0 0 8px 0;
        }

        .markdown-preview p:last-child {
            margin-bottom: 0;
        }

        .markdown-preview strong {
            font-weight: 600;
        }

        .markdown-preview em {
            font-style: italic;
        }

        .markdown-preview a {
            color: var(--primary);
        }

        .markdown-preview ul, .markdown-preview ol {
            margin: 0 0 8px 0;
            padding-left: 20px;
        }

        /* Visual editor scrollable area */
        .visual-editor {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .visual-editor::-webkit-scrollbar {
            width: 6px;
        }

        .visual-editor::-webkit-scrollbar-track {
            background: transparent;
        }

        .visual-editor::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Code editor wrapper */
        .code-editor {
            display: none;
        }

        .code-editor.active {
            display: block;
        }

        /* Map Picker Overlay */
        .map-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .map-picker-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .map-picker-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .map-picker-search {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .map-picker-search input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .map-picker-search input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .map-picker-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
        }

        .map-picker-search-results.visible {
            display: block;
        }

        .map-picker-search-result {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
        }

        .map-picker-search-result:last-child {
            border-bottom: none;
        }

        .map-picker-search-result:hover {
            background: var(--bg-subtle);
        }

        .map-picker-body {
            flex: 1;
            position: relative;
        }

        .map-picker-body #pickerMap {
            width: 100%;
            height: 100%;
        }

        .map-picker-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }

        .map-picker-coords {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .map-picker-coords strong {
            color: var(--text-primary);
        }

        .map-picker-actions {
            display: flex;
            gap: 12px;
        }

        /* Reorder dialog */
        .reorder-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .reorder-dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .reorder-dialog {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
            padding: 24px;
        }

        .reorder-dialog h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .reorder-dialog p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .reorder-dialog-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reorder-dialog-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            font-family: inherit;
        }

        .reorder-dialog-option:hover {
            background: var(--bg-card);
            border-color: var(--primary);
        }

        /* Responsive adjustments for visual editor */
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .coords-row {
                grid-template-columns: 1fr 1fr;
            }

            .coords-row .btn-map-picker {
                grid-column: 1 / -1;
                width: 100%;
                height: 36px;
            }

            .editor-tabs {
                flex-direction: column;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }

            .container {
                flex-direction: column;
                height: auto;
            }

            #map {
                width: 100%;
                height: 400px;
                page-break-inside: avoid;
            }

            .sidebar {
                position: relative !important;
                width: 100% !important;
                height: auto !important;
                border: none;
                box-shadow: none;
                transform: none !important;
                page-break-before: always;
            }

            .timeline {
                overflow: visible;
            }

            .stop {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ddd;
                margin-bottom: 8px;
            }

            .action-buttons,
            .controls,
            .mobile-toggle,
            .modal-overlay,
            .toast,
            .dropdown-content,
            .leaflet-control-zoom,
            .leaflet-control-attribution,
            .warning-message {
                display: none !important;
            }

            .stats {
                page-break-inside: avoid;
                background: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .stop-number,
            .stop-type-badge {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .header {
                border-bottom: 2px solid var(--primary);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar app-hidden" id="sidebar">
            <div class="header">
                <h1 id="tripTitle"><span class="emoji" id="tripEmoji"></span> <span id="tripName"></span></h1>
                <div class="subtitle" id="tripDates"></div>
            </div>

            <div class="action-buttons">
                <button class="action-btn" id="shareBtn" title="Sd√≠let pl√°n">
                    <span>Sd√≠let</span>
                </button>
                <button class="action-btn" id="editJsonBtn" title="Upravit JSON">
                    <span>Upravit JSON</span>
                </button>
                <div class="dropdown" id="exportDropdown">
                    <button class="action-btn" id="exportBtn" title="Export">
                        <span>Export ‚ñæ</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="dropdown-item" id="exportPngBtn">Exportovat PNG</button>
                        <button class="dropdown-item" id="printBtn">Tisk</button>
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="control-item">
                    <input type="checkbox" id="showRoutes" checked>
                    <label for="showRoutes">Zobrazit spojnice trasy</label>
                </div>
                <div class="control-item">
                    <input type="checkbox" id="showLabels" checked>
                    <label for="showLabels">Zobrazit popisky na mapƒõ</label>
                </div>
            </div>

            <div class="timeline" id="timeline"></div>

            <div class="stats" id="stats">
                <h3><span class="emoji">Statistiky cesty</span></h3>
                <div class="stat-row">
                    <span class="stat-label">Celkov√° d√©lka</span>
                    <span class="stat-value" id="statNights">0 noc√≠</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Poƒçet zast√°vek</span>
                    <span class="stat-value" id="statStops">0 m√≠st</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobiln√≠ p≈ôep√≠naƒç -->
    <button class="mobile-toggle" id="mobileToggle">Zobrazit seznam</button>

    <!-- Toast notifikace -->
    <div class="toast" id="toast"></div>

    <!-- Input modal -->
    <div class="modal-overlay" id="inputModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Zadejte cestovn√≠ pl√°n</h2>
                <p>Vytvo≈ôte pl√°n vizu√°lnƒõ nebo vlo≈æte JSON.</p>
            </div>
            <div class="modal-body">
                <!-- Tab switcher -->
                <div class="editor-tabs">
                    <button class="editor-tab active" data-mode="visual">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                        </svg>
                        Vizu√°ln√≠ editor
                    </button>
                    <button class="editor-tab" data-mode="code">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 18 22 12 16 6"></polyline>
                            <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        JSON k√≥d
                    </button>
                </div>

                <div class="error-summary" id="errorSummary">
                    <h4>Nalezeny chyby:</h4>
                    <ul id="errorList"></ul>
                </div>

                <!-- Visual Editor -->
                <div class="visual-editor">
                    <div class="visual-editor-stats">
                        <div class="visual-editor-stat">Zast√°vky: <strong id="inputStatsStops">0</strong></div>
                        <div class="visual-editor-stat">Noc√≠: <strong id="inputStatsNights">0</strong></div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Z√°kladn√≠ informace</h3>
                        <div class="form-group">
                            <label for="inputPlanName">N√°zev pl√°nu *</label>
                            <input type="text" id="inputPlanName" class="form-input" placeholder="nap≈ô. üè∞ V√≠kend v Praze">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="inputPlanDateFrom">Datum od</label>
                                <input type="date" id="inputPlanDateFrom" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="inputPlanDateTo">Datum do</label>
                                <input type="date" id="inputPlanDateTo" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-header">
                            <h3 class="form-section-title">Zast√°vky</h3>
                            <button type="button" class="btn-add-stop" id="inputAddStopBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                P≈ôidat zast√°vku
                            </button>
                        </div>
                        <div class="stops-list" id="inputStopsList"></div>
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="code-editor">
                    <div class="drop-zone" id="dropZone">
                        <div class="drop-zone-icon">üìÅ</div>
                        <div class="drop-zone-text">P≈ôet√°hnƒõte sem JSON soubor</div>
                        <div class="drop-zone-subtext">nebo kliknƒõte pro v√Ωbƒõr souboru</div>
                        <input type="file" class="file-input" id="fileInput" accept=".json,application/json">
                    </div>

                    <div class="ace-editor-container" id="jsonInputContainer"></div>

                    <button class="example-toggle" id="exampleToggle">Zobrazit uk√°zkov√Ω JSON</button>
                    <div class="example-json" id="exampleJson" style="display: none;">
<pre>{
  "name": "üè∞ V√≠kend v Praze",
  "stops": [
    {
      "name": "Praha - Star√© Mƒõsto",
      "lat": 50.0875,
      "lng": 14.4214,
      "dateFrom": "2025-03-01",
      "dateTo": "2025-03-02"
    },
    {
      "name": "Karl≈°tejn",
      "lat": 49.9394,
      "lng": 14.1883,
      "dateTo": "2025-03-02",
      "notes": "Jednodenn√≠ v√Ωlet"
    },
    {
      "name": "Praha - Leti≈°tƒõ",
      "lat": 50.1008,
      "lng": 14.2600,
      "dateFrom": "2025-03-02",
      "dateTo": "2025-03-03"
    }
  ]
}</pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="useExampleBtn">Pou≈æ√≠t uk√°zku</button>
                <button class="btn btn-primary" id="loadJsonBtn">Naƒç√≠st pl√°n</button>
            </div>
        </div>
    </div>

    <!-- Recovery modal -->
    <div class="modal-overlay" id="recoveryModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Obnovit p≈ôedchoz√≠ pl√°n?</h2>
            </div>
            <div class="modal-body">
                <div class="recovery-info">
                    <h3 id="recoveryName"></h3>
                    <p id="recoveryDetails"></p>
                </div>
                <p style="font-size: 0.875rem; color: var(--text-secondary);">
                    M√°te ulo≈æen√Ω cestovn√≠ pl√°n z p≈ôedchoz√≠ n√°v≈°tƒõvy. Chcete ho obnovit nebo zaƒç√≠t znovu?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="startNewBtn">Zaƒç√≠t znovu</button>
                <button class="btn btn-primary" id="recoverBtn">Obnovit</button>
            </div>
        </div>
    </div>

    <!-- Editor modal -->
    <div class="modal-overlay" id="editorModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Upravit pl√°n</h2>
                <p>Upravte pl√°n vizu√°lnƒõ nebo v JSON form√°tu.</p>
            </div>
            <div class="modal-body">
                <!-- Tab switcher -->
                <div class="editor-tabs">
                    <button class="editor-tab active" data-mode="visual">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                        </svg>
                        Vizu√°ln√≠ editor
                    </button>
                    <button class="editor-tab" data-mode="code">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 18 22 12 16 6"></polyline>
                            <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        JSON k√≥d
                    </button>
                </div>

                <div class="error-summary" id="editorErrorSummary">
                    <h4>Nalezeny chyby:</h4>
                    <ul id="editorErrorList"></ul>
                </div>

                <!-- Visual Editor -->
                <div class="visual-editor">
                    <div class="visual-editor-stats">
                        <div class="visual-editor-stat">Zast√°vky: <strong id="editorStatsStops">0</strong></div>
                        <div class="visual-editor-stat">Noc√≠: <strong id="editorStatsNights">0</strong></div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Z√°kladn√≠ informace</h3>
                        <div class="form-group">
                            <label for="editorPlanName">N√°zev pl√°nu *</label>
                            <input type="text" id="editorPlanName" class="form-input" placeholder="nap≈ô. üè∞ V√≠kend v Praze">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editorPlanDateFrom">Datum od</label>
                                <input type="date" id="editorPlanDateFrom" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="editorPlanDateTo">Datum do</label>
                                <input type="date" id="editorPlanDateTo" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-header">
                            <h3 class="form-section-title">Zast√°vky</h3>
                            <button type="button" class="btn-add-stop" id="editorAddStopBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                P≈ôidat zast√°vku
                            </button>
                        </div>
                        <div class="stops-list" id="editorStopsList"></div>
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="code-editor">
                    <div class="ace-editor-container tall" id="editorJsonContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="copyJsonBtn">Kop√≠rovat JSON</button>
                <button class="btn btn-secondary" id="cancelEditBtn">Zru≈°it</button>
                <button class="btn btn-primary" id="saveJsonBtn">Ulo≈æit zmƒõny</button>
            </div>
        </div>
    </div>

    <!-- Reorder dialog -->
    <div class="reorder-dialog-overlay" id="reorderDialogOverlay">
        <div class="reorder-dialog">
            <h3>√öprava po≈ôad√≠</h3>
            <p>Jak chcete upravit datumy po p≈ôe≈ôazen√≠ zast√°vky?</p>
            <div class="reorder-dialog-options">
                <button class="reorder-dialog-option" data-action="shift">Posunout v≈°e relativnƒõ</button>
                <button class="reorder-dialog-option" data-action="fix">Jen opravit p≈ôekryvy</button>
                <button class="reorder-dialog-option" data-action="none">Nechat beze zmƒõny</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet.Geodesic pro geodetick√© k≈ôivky (mus√≠ b√Ωt po leaflet.js) -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.geodesic@2.7.1/dist/leaflet.geodesic.umd.min.js"></script>
    <script>
    (function() {
        'use strict';

        // =====================
        // i18n p≈ô√≠prava
        // =====================
        const translations = {
            cs: {
                title: 'Cestovn√≠ pl√°novaƒç',
                loadPlan: 'Naƒç√≠st pl√°n',
                useExample: 'Pou≈æ√≠t uk√°zku',
                share: 'Sd√≠let',
                editJson: 'Upravit JSON',
                exportPng: 'Export PNG',
                showRoutes: 'Zobrazit spojnice trasy',
                showLabels: 'Zobrazit popisky na mapƒõ',
                stats: 'Statistiky cesty',
                totalNights: 'Celkov√° d√©lka',
                stopCount: 'Poƒçet zast√°vek',
                nights: 'noc√≠',
                places: 'm√≠st',
                showList: 'Zobrazit seznam',
                showMap: 'Zobrazit mapu',
                errors: {
                    invalidJson: 'JSON nen√≠ platn√Ω. Zkontrolujte, zda jsou v≈°echny z√°vorky spr√°vnƒõ uzav≈ôen√©.',
                    missingField: 'Chyb√≠ povinn√© pole "{field}" v hlavn√≠ ƒç√°sti pl√°nu.',
                    missingStopField: 'Zast√°vka ƒç. {num} nem√° zadan√© pole "{field}".',
                    invalidLat: 'Zast√°vka ƒç. {num}: Zemƒõpisn√° ≈°√≠≈ôka (lat) mus√≠ b√Ωt v rozsahu -90 a≈æ 90.',
                    invalidLng: 'Zast√°vka ƒç. {num}: Zemƒõpisn√° d√©lka (lng) mus√≠ b√Ωt v rozsahu -180 a≈æ 180.',
                    emptyStops: 'Pl√°n mus√≠ obsahovat alespo≈à jednu zast√°vku.',
                    dateToBeforeDateFrom: 'Zast√°vka ƒç. {num}: dateTo ({dateTo}) je d≈ô√≠ve ne≈æ dateFrom ({dateFrom}).',
                    datesNotChronological: 'Zast√°vka ƒç. {num}: datum nenavazuje na p≈ôedchoz√≠ zast√°vku.',
                    datesOverlap: 'Zast√°vka ƒç. {num}: data se p≈ôekr√Ωvaj√≠ s p≈ôedchoz√≠ zast√°vkou.',
                    extremeDistance: 'Upozornƒõn√≠: Vzd√°lenost mezi zast√°vkou ƒç. {num1} a ƒç. {num2} je vƒõt≈°√≠ ne≈æ 5000 km.'
                },
                toast: {
                    copied: 'Odkaz byl zkop√≠rov√°n do schr√°nky',
                    jsonCopied: 'JSON byl zkop√≠rov√°n do schr√°nky',
                    saved: 'Zmƒõny byly ulo≈æeny',
                    exportStarted: 'Generuji obr√°zek...',
                    exportDone: 'Export dokonƒçen',
                    exportFailed: 'Export selhal'
                },
                badges: {
                    start: 'üü¢ Start',
                    end: 'üî¥ C√≠l',
                    dayTrip: '‚òÄÔ∏è Denn√≠ v√Ωlet'
                }
            }
        };

        const lang = 'cs';
        const t = (key, params = {}) => {
            const keys = key.split('.');
            let value = translations[lang];
            for (const k of keys) {
                value = value?.[k];
            }
            if (typeof value === 'string') {
                return value.replace(/\{(\w+)\}/g, (_, p) => params[p] || '');
            }
            return key;
        };

        // =====================
        // Stav aplikace
        // =====================
        let currentPlan = null;
        let leafletMap = null;
        let markers = [];
        let labels = [];
        let routeLine = null;
        let geodesicLine = null;
        let inputEditor = null;
        let editorEditor = null;
        let warnings = [];

        // =====================
        // DOM elementy
        // =====================
        const sidebar = document.getElementById('sidebar');
        const inputModal = document.getElementById('inputModal');
        const recoveryModal = document.getElementById('recoveryModal');
        const editorModal = document.getElementById('editorModal');
        const toast = document.getElementById('toast');
        const jsonInputContainer = document.getElementById('jsonInputContainer');
        const editorJsonContainer = document.getElementById('editorJsonContainer');
        const errorSummary = document.getElementById('errorSummary');
        const errorList = document.getElementById('errorList');
        const editorErrorSummary = document.getElementById('editorErrorSummary');
        const editorErrorList = document.getElementById('editorErrorList');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const mobileToggle = document.getElementById('mobileToggle');
        const exportDropdown = document.getElementById('exportDropdown');

        // =====================
        // Pomocn√© funkce
        // =====================
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        function showModal(modal) {
            modal.classList.add('visible');
        }

        function hideModal(modal) {
            modal.classList.remove('visible');
        }

        function formatNights(count) {
            if (!count) return '';
            if (count === 1) return '1 noc';
            if (count < 5) return `${count} noci`;
            return `${count} noc√≠`;
        }

        function formatPlaces(count) {
            if (count === 1) return '1 m√≠sto';
            if (count < 5) return `${count} m√≠sta`;
            return `${count} m√≠st`;
        }

        // Form√°tov√°n√≠ data ƒçesky (15. ledna 2025)
        function formatDateCzech(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            const months = ['ledna', '√∫nora', 'b≈ôezna', 'dubna', 'kvƒõtna', 'ƒçervna',
                            'ƒçervence', 'srpna', 'z√°≈ô√≠', '≈ô√≠jna', 'listopadu', 'prosince'];
            return `${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        // V√Ωpoƒçet noc√≠ z dateFrom a dateTo
        function calculateNights(dateFrom, dateTo) {
            if (!dateFrom || !dateTo) return 0;
            const from = new Date(dateFrom);
            const to = new Date(dateTo);
            if (isNaN(from.getTime()) || isNaN(to.getTime())) return 0;
            const diffTime = to.getTime() - from.getTime();
            return Math.max(0, Math.round(diffTime / (1000 * 60 * 60 * 24)));
        }

        // Extrakce emoji z n√°zvu
        function parseNameWithEmoji(name) {
            if (!name) return { emoji: '', name: '' };
            const match = name.match(/^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F?)\s*/u);
            return {
                emoji: match ? match[1] : '',
                name: match ? name.slice(match[0].length) : name
            };
        }

        // V√Ωpoƒçet vzd√°lenosti mezi dvƒõma body (Haversine formula)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Polomƒõr Zemƒõ v km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Form√°tov√°n√≠ rozsahu dat
        function formatDateRange(dateFrom, dateTo) {
            if (!dateFrom && !dateTo) return '';
            if (!dateFrom) return formatDateCzech(dateTo);
            if (!dateTo) return formatDateCzech(dateFrom);
            return `${formatDateCzech(dateFrom)} ‚Äì ${formatDateCzech(dateTo)}`;
        }

        // =====================
        // URL komprese/dekomprese
        // =====================
        function compressJSON(json) {
            const jsonStr = JSON.stringify(json);
            return LZString.compressToEncodedURIComponent(jsonStr);
        }

        function decompressJSON(str) {
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(str);
                return JSON.parse(decompressed);
            } catch (e) {
                return null;
            }
        }

        function getShareURL() {
            if (!currentPlan) return null;
            const compressed = compressJSON(currentPlan);
            return `${window.location.origin}${window.location.pathname}?plan=${compressed}`;
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const planParam = params.get('plan');
            if (planParam) {
                const plan = decompressJSON(planParam);
                if (plan) {
                    return plan;
                }
            }
            return null;
        }

        // =====================
        // LocalStorage
        // =====================
        const STORAGE_KEY = 'travel-planner-saved-plan-v2';
        const OLD_STORAGE_KEY = 'travel-planner-saved-plan';

        function savePlanToStorage(plan) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(plan));
            } catch (e) {
                console.warn('Nepoda≈ôilo se ulo≈æit pl√°n do localStorage:', e);
            }
        }

        function loadPlanFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Nepoda≈ôilo se naƒç√≠st pl√°n z localStorage:', e);
            }
            return null;
        }

        function clearStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (e) {
                console.warn('Nepoda≈ôilo se vymazat localStorage:', e);
            }
        }

        // Smazat star√© nekompatibiln√≠ data p≈ôi startu
        function clearOldStorage() {
            try {
                localStorage.removeItem(OLD_STORAGE_KEY);
            } catch (e) {
                // Ignorovat
            }
        }

        // =====================
        // Parsov√°n√≠ datum≈Ø (flexibiln√≠)
        // =====================
        function tryParseDate(str) {
            if (!str) return null;

            // Pokus o r≈Øzn√© form√°ty
            const formats = [
                // d.m.Y
                /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/,
                // d. m. Y
                /^(\d{1,2})\.\s*(\d{1,2})\.\s*(\d{4})$/,
                // Y-m-d
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/,
                // Y/m/d
                /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/,
            ];

            for (const fmt of formats) {
                const match = str.match(fmt);
                if (match) {
                    if (fmt.source.startsWith('(\\d{4})')) {
                        // Y-m-d nebo Y/m/d
                        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                    } else {
                        // d.m.Y
                        return new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
                    }
                }
            }

            // ƒåesk√© mƒõs√≠ce
            const czechMonths = {
                'ledna': 0, '√∫nora': 1, 'b≈ôezna': 2, 'dubna': 3, 'kvƒõtna': 4, 'ƒçervna': 5,
                'ƒçervence': 6, 'srpna': 7, 'z√°≈ô√≠': 8, '≈ô√≠jna': 9, 'listopadu': 10, 'prosince': 11
            };

            const czechMatch = str.match(/(\d{1,2})\.\s*(\w+)\s*(\d{4})/);
            if (czechMatch) {
                const month = czechMonths[czechMatch[2].toLowerCase()];
                if (month !== undefined) {
                    return new Date(parseInt(czechMatch[3]), month, parseInt(czechMatch[1]));
                }
            }

            // Fallback na native Date
            const native = new Date(str);
            if (!isNaN(native.getTime())) {
                return native;
            }

            return null;
        }

        // =====================
        // Validace JSON
        // =====================
        function validatePlan(plan) {
            const errors = [];
            warnings = []; // Reset warnings

            // Povinn√° pole hlavn√≠ho objektu (nov√° struktura)
            if (!plan.name) {
                errors.push(t('errors.missingField', { field: 'name' }));
            }
            if (!plan.stops) {
                errors.push(t('errors.missingField', { field: 'stops' }));
            }

            // Kontrola zast√°vek
            if (Array.isArray(plan.stops)) {
                if (plan.stops.length === 0) {
                    errors.push(t('errors.emptyStops'));
                }

                let prevDateTo = null;

                plan.stops.forEach((stop, idx) => {
                    const num = idx + 1;

                    // Povinn√° pole zast√°vky
                    if (!stop.name) {
                        errors.push(t('errors.missingStopField', { num, field: 'name' }));
                    }
                    if (stop.lat === undefined || stop.lat === null) {
                        errors.push(t('errors.missingStopField', { num, field: 'lat' }));
                    } else if (stop.lat < -90 || stop.lat > 90) {
                        errors.push(t('errors.invalidLat', { num }));
                    }
                    if (stop.lng === undefined || stop.lng === null) {
                        errors.push(t('errors.missingStopField', { num, field: 'lng' }));
                    } else if (stop.lng < -180 || stop.lng > 180) {
                        errors.push(t('errors.invalidLng', { num }));
                    }

                    // Validace dat
                    if (stop.dateFrom && stop.dateTo) {
                        const from = new Date(stop.dateFrom);
                        const to = new Date(stop.dateTo);
                        if (!isNaN(from.getTime()) && !isNaN(to.getTime())) {
                            if (to < from) {
                                errors.push(t('errors.dateToBeforeDateFrom', {
                                    num,
                                    dateFrom: stop.dateFrom,
                                    dateTo: stop.dateTo
                                }));
                            }
                        }
                    }

                    // Validace chronologie
                    const currentDateFrom = stop.dateFrom ? new Date(stop.dateFrom) :
                                           (stop.dateTo ? new Date(stop.dateTo) : null);

                    if (prevDateTo && currentDateFrom) {
                        if (currentDateFrom < prevDateTo) {
                            errors.push(t('errors.datesOverlap', { num }));
                        }
                    }

                    if (stop.dateTo) {
                        prevDateTo = new Date(stop.dateTo);
                    }

                    // Kontrola extr√©mn√≠ vzd√°lenosti
                    if (idx > 0 && plan.stops[idx - 1].lat !== undefined && stop.lat !== undefined) {
                        const prevStop = plan.stops[idx - 1];
                        const distance = calculateDistance(prevStop.lat, prevStop.lng, stop.lat, stop.lng);
                        if (distance > 5000) {
                            warnings.push(t('errors.extremeDistance', { num1: idx, num2: num }));
                        }
                    }
                });
            }

            return errors;
        }

        function showErrors(errors, summaryEl, listEl, containerEl) {
            if (errors.length === 0) {
                summaryEl.classList.remove('visible');
                containerEl?.classList.remove('has-error');
                return false;
            }

            listEl.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
            summaryEl.classList.add('visible');
            containerEl?.classList.add('has-error');
            return true;
        }

        // =====================
        // Detekce duplicitn√≠ch sou≈ôadnic a offset
        // =====================
        function applyCoordinateOffsets(stops) {
            const coordMap = new Map();
            const offsetAmount = 0.015; // p≈ôibli≈ænƒõ 1.5km

            return stops.map((stop, index) => {
                const key = `${stop.lat.toFixed(4)},${stop.lng.toFixed(4)}`;

                if (!coordMap.has(key)) {
                    coordMap.set(key, []);
                }

                const existing = coordMap.get(key);
                const offsetIndex = existing.length;
                existing.push(index);

                if (offsetIndex === 0) {
                    return { ...stop };
                }

                // Aplikovat offset
                const angle = (offsetIndex * 90) * (Math.PI / 180);
                return {
                    ...stop,
                    lat: stop.lat + offsetAmount * Math.cos(angle),
                    lng: stop.lng + offsetAmount * Math.sin(angle)
                };
            });
        }

        // =====================
        // Vytvo≈ôen√≠ zak≈ôiven√© cesty (B√©zierova k≈ôivka)
        // =====================
        function createCurvedPath(start, end) {
            const points = [];
            const midLat = (start[0] + end[0]) / 2;
            const midLng = (start[1] + end[1]) / 2;

            // Kolm√Ω offset pro kontroln√≠ bod (v≈ædy vpravo)
            const dx = end[1] - start[1];
            const dy = end[0] - start[0];
            const dist = Math.sqrt(dx * dx + dy * dy);
            const curve = Math.max(0.08, Math.min(0.2, 0.35 / (dist + 0.1)));

            const ctrlLat = midLat + (-dx) * curve;
            const ctrlLng = midLng + dy * curve;

            // Generovat body k≈ôivky
            for (let t = 0; t <= 1; t += 0.05) {
                const lat = (1 - t) * (1 - t) * start[0] + 2 * (1 - t) * t * ctrlLat + t * t * end[0];
                const lng = (1 - t) * (1 - t) * start[1] + 2 * (1 - t) * t * ctrlLng + t * t * end[1];
                points.push([lat, lng]);
            }
            return points;
        }

        // =====================
        // Vykreslen√≠ pl√°nu
        // =====================
        function renderPlan(plan) {
            currentPlan = plan;
            savePlanToStorage(plan);

            // Extrahovat emoji a n√°zev
            const parsed = parseNameWithEmoji(plan.name);

            // Vypoƒç√≠tat datumy z zast√°vek pokud nejsou definov√°ny
            let tripDateFrom = plan.dateFrom;
            let tripDateTo = plan.dateTo;

            if (plan.stops && plan.stops.length > 0) {
                const allDates = plan.stops
                    .flatMap(s => [s.dateFrom, s.dateTo])
                    .filter(d => d)
                    .map(d => new Date(d))
                    .filter(d => !isNaN(d.getTime()));

                if (allDates.length > 0) {
                    const minDate = new Date(Math.min(...allDates.map(d => d.getTime())));
                    const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())));
                    if (!tripDateFrom) tripDateFrom = minDate.toISOString().split('T')[0];
                    if (!tripDateTo) tripDateTo = maxDate.toISOString().split('T')[0];
                }
            }

            // Aktualizace hlaviƒçky
            document.getElementById('tripEmoji').textContent = parsed.emoji;
            document.getElementById('tripName').textContent = parsed.name;

            // Form√°tovat datumy pro hlaviƒçku
            let datesText = '';
            if (tripDateFrom && tripDateTo) {
                datesText = `${formatDateCzech(tripDateFrom)} ‚Äì ${formatDateCzech(tripDateTo)}`;
            } else if (tripDateFrom || tripDateTo) {
                datesText = `${formatDateCzech(tripDateFrom || '?')} ‚Äì ${formatDateCzech(tripDateTo || '?')}`;
            }
            document.getElementById('tripDates').textContent = datesText;
            document.title = `${parsed.name} | Cestovn√≠ pl√°novaƒç`;

            // Aplikovat offset na duplicitn√≠ sou≈ôadnice
            const stopsWithOffset = applyCoordinateOffsets(plan.stops);

            // Vyƒçistit existuj√≠c√≠ markery
            markers.forEach(m => leafletMap.removeLayer(m));
            labels.forEach(l => leafletMap.removeLayer(l));
            if (routeLine) leafletMap.removeLayer(routeLine);
            if (geodesicLine) leafletMap.removeLayer(geodesicLine);
            markers = [];
            labels = [];

            // Barvy marker≈Ø
            const markerColors = ['#E07A5F', '#F2CC8F', '#81B29A', '#3D405B', '#E07A5F', '#81B29A', '#3D405B', '#C45D45'];
            const totalStops = stopsWithOffset.length;

            // Vytvo≈ôit markery
            stopsWithOffset.forEach((stop, index) => {
                const color = markerColors[index % markerColors.length];

                // Urƒçit typ podle pozice (prvn√≠ = start, posledn√≠ = c√≠l)
                const isStart = index === 0;
                const isEnd = index === totalStops - 1;

                // Ikona pro start/c√≠l
                let iconHtml = `<div style="
                    background: ${color};
                    width: 28px;
                    height: 28px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: 600;
                    font-size: 12px;
                    font-family: 'Inter', sans-serif;
                    border: 2px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                ">${index + 1}</div>`;

                if (isStart) {
                    iconHtml = `<div style="
                        background: #059669;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 700;
                        font-size: 14px;
                        font-family: 'Inter', sans-serif;
                        border: 3px solid white;
                        box-shadow: 0 2px 10px rgba(5,150,105,0.4);
                    ">S</div>`;
                } else if (isEnd) {
                    iconHtml = `<div style="
                        background: #DC2626;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 700;
                        font-size: 14px;
                        font-family: 'Inter', sans-serif;
                        border: 3px solid white;
                        box-shadow: 0 2px 10px rgba(220,38,38,0.4);
                    ">C</div>`;
                }

                const marker = L.marker([stop.lat, stop.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: iconHtml,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14],
                        popupAnchor: [0, -14]
                    })
                }).addTo(leafletMap);

                // Vypoƒç√≠tat noci a form√°tovat datumy
                const nights = calculateNights(stop.dateFrom, stop.dateTo);
                const dateRange = formatDateRange(stop.dateFrom, stop.dateTo);

                const popupContent = `
                    <div class="popup-title">${stop.label || stop.name}</div>
                    ${dateRange ? `<div class="popup-dates">${dateRange}</div>` : ''}
                    ${nights > 0 ? `<div class="popup-nights">${formatNights(nights)}</div>` : ''}
                `;
                marker.bindPopup(popupContent);
                markers.push(marker);

                // Popisky
                const labelText = stop.label || stop.name;
                const verticalOffset = index % 2 === 0 ? -8 : 28;
                const label = L.marker([stop.lat, stop.lng], {
                    icon: L.divIcon({
                        className: 'map-label-container',
                        html: `<div style="
                            background: white;
                            color: #2D3142;
                            padding: 5px 10px;
                            border-radius: 6px;
                            font-size: 11px;
                            font-weight: 500;
                            font-family: 'Inter', sans-serif;
                            white-space: nowrap;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
                            border: 1px solid rgba(0,0,0,0.06);
                            margin-left: 20px;
                        ">${labelText}</div>`,
                        iconAnchor: [0, verticalOffset]
                    })
                }).addTo(leafletMap);
                labels.push(label);
            });

            // Zak≈ôiven√© spojnice (B√©zierovy k≈ôivky)
            const routeCoords = stopsWithOffset.map(s => [s.lat, s.lng]);
            const allCurvePoints = [];

            for (let i = 0; i < routeCoords.length - 1; i++) {
                const curvePoints = createCurvedPath(routeCoords[i], routeCoords[i + 1]);
                allCurvePoints.push(...curvePoints);
            }

            if (allCurvePoints.length > 0) {
                routeLine = L.polyline(allCurvePoints, {
                    color: '#E07A5F',
                    weight: 3,
                    opacity: 0.7,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(leafletMap);
            }

            // Timeline
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            // Odstranit p≈ôedchoz√≠ warning element pokud existuje
            const existingWarning = document.querySelector('.warning-message');
            if (existingWarning) existingWarning.remove();

            // Zobrazit warnings pokud existuj√≠
            if (warnings.length > 0) {
                const warningEl = document.createElement('div');
                warningEl.className = 'warning-message';
                warningEl.innerHTML = warnings.join('<br>');
                timeline.parentNode.insertBefore(warningEl, timeline);
            }

            let totalNights = 0;
            let hasIncompleteDates = false;

            plan.stops.forEach((stop, index) => {
                const offsetStop = stopsWithOffset[index];
                const color = markerColors[index % markerColors.length];

                // Urƒçit typ podle pozice
                const isStart = index === 0;
                const isEnd = index === totalStops - 1;

                // Vypoƒç√≠tat noci
                const nights = calculateNights(stop.dateFrom, stop.dateTo);
                const isDayTrip = stop.dateTo && !stop.dateFrom;

                if (stop.dateFrom || stop.dateTo) {
                    totalNights += nights;
                } else {
                    hasIncompleteDates = true;
                }

                const stopEl = document.createElement('div');
                stopEl.className = 'stop';
                stopEl.dataset.index = index;

                let typeColor = color;
                let typeBadge = '';
                if (isStart) {
                    typeColor = '#059669';
                    typeBadge = `<span class="stop-type-badge start">${t('badges.start')}</span>`;
                } else if (isEnd) {
                    typeColor = '#DC2626';
                    typeBadge = `<span class="stop-type-badge cil">${t('badges.end')}</span>`;
                } else if (isDayTrip) {
                    typeBadge = `<span class="stop-type-badge" style="background: #FEF3C7; color: #92400E;">${t('badges.dayTrip')}</span>`;
                }

                const dateRange = formatDateRange(stop.dateFrom, stop.dateTo);

                stopEl.innerHTML = `
                    <div class="stop-number" style="background: ${typeColor}">${index + 1}</div>
                    <div class="stop-name">${stop.label || stop.name}${typeBadge}</div>
                    ${dateRange ? `<div class="stop-dates">${dateRange}${nights > 0 ? `<span class="stop-nights">${formatNights(nights)}</span>` : ''}</div>` : ''}
                    ${stop.notes ? `<div class="stop-notes"><span class="notes-icon">‚Üí</span><span>${stop.notes}</span></div>` : ''}
                `;

                stopEl.addEventListener('click', () => {
                    document.querySelectorAll('.stop').forEach(s => s.classList.remove('active'));
                    stopEl.classList.add('active');

                    leafletMap.flyTo([offsetStop.lat, offsetStop.lng], 11, {
                        animate: true,
                        duration: 0.8
                    });
                    setTimeout(() => markers[index].openPopup(), 400);
                });

                timeline.appendChild(stopEl);
            });

            // Statistiky
            let nightsText = formatNights(totalNights) || '0 noc√≠';
            if (hasIncompleteDates) {
                nightsText += ' *';
            }
            document.getElementById('statNights').textContent = nightsText;
            document.getElementById('statStops').textContent = formatPlaces(plan.stops.length);

            // P≈ôizp≈Øsobit zoom
            const bounds = L.latLngBounds(routeCoords);
            leafletMap.fitBounds(bounds, { padding: [50, 50] });

            // Zobrazit sidebar
            sidebar.classList.remove('app-hidden');
        }

        // =====================
        // Inicializace mapy
        // =====================
        function initMap() {
            leafletMap = L.map('map').setView([50, 15], 5);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(leafletMap);
        }

        // =====================
        // Inicializace Ace Editor≈Ø
        // =====================
        function initAceEditors() {
            // Input editor
            inputEditor = ace.edit("jsonInputContainer");
            inputEditor.setTheme("ace/theme/tomorrow");
            inputEditor.session.setMode("ace/mode/json");
            inputEditor.setShowPrintMargin(false);
            inputEditor.setOptions({
                fontSize: "13px",
                showLineNumbers: true,
                tabSize: 2,
                useSoftTabs: true,
                wrap: true
            });

            // Editor modal editor
            editorEditor = ace.edit("editorJsonContainer");
            editorEditor.setTheme("ace/theme/tomorrow");
            editorEditor.session.setMode("ace/mode/json");
            editorEditor.setShowPrintMargin(false);
            editorEditor.setOptions({
                fontSize: "13px",
                showLineNumbers: true,
                tabSize: 2,
                useSoftTabs: true,
                wrap: true
            });
        }

        // Pomocn√° funkce pro auto-format JSON
        function formatJsonInEditor(editor) {
            try {
                const value = editor.getValue();
                if (value.trim()) {
                    const parsed = JSON.parse(value);
                    editor.setValue(JSON.stringify(parsed, null, 2), -1);
                }
            } catch (e) {
                // Nechat jak je pokud nen√≠ validn√≠ JSON
            }
        }

        // =====================
        // Event handlery
        // =====================
        function setupEventHandlers() {
            // Input modal
            document.getElementById('loadJsonBtn').addEventListener('click', () => {
                const plan = VisualEditor.getPlan('input');

                if (!plan) {
                    showErrors([t('errors.invalidJson')], errorSummary, errorList, jsonInputContainer);
                    return;
                }

                const errors = validatePlan(plan);
                if (showErrors(errors, errorSummary, errorList, jsonInputContainer)) {
                    return;
                }

                VisualEditor.clearDraft('input');
                hideModal(inputModal);
                renderPlan(plan);
            });

            document.getElementById('useExampleBtn').addEventListener('click', () => {
                const example = {
                    name: "üè∞ V√≠kend v Praze",
                    stops: [
                        { name: "Praha - Star√© Mƒõsto", lat: 50.0875, lng: 14.4214, dateFrom: "2025-03-01", dateTo: "2025-03-02" },
                        { name: "Karl≈°tejn", lat: 49.9394, lng: 14.1883, dateTo: "2025-03-02", notes: "Jednodenn√≠ v√Ωlet" },
                        { name: "Praha - Leti≈°tƒõ", lat: 50.1008, lng: 14.2600, dateFrom: "2025-03-02", dateTo: "2025-03-03" }
                    ]
                };
                VisualEditor.clearDraft('input');
                hideModal(inputModal);
                renderPlan(example);
            });

            // Toggle example
            document.getElementById('exampleToggle').addEventListener('click', () => {
                const exampleDiv = document.getElementById('exampleJson');
                const toggle = document.getElementById('exampleToggle');
                if (exampleDiv.style.display === 'none') {
                    exampleDiv.style.display = 'block';
                    toggle.textContent = 'Skr√Ωt uk√°zkov√Ω JSON';
                } else {
                    exampleDiv.style.display = 'none';
                    toggle.textContent = 'Zobrazit uk√°zkov√Ω JSON';
                }
            });

            // Drag & drop
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');

                const file = e.dataTransfer.files[0];
                if (file && (file.type === 'application/json' || file.name.endsWith('.json'))) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const plan = JSON.parse(ev.target.result);
                            // Naƒç√≠st do vizu√°ln√≠ho editoru
                            VisualEditor.loadPlan('input', plan);
                        } catch (err) {
                            // P≈ôi chybƒõ naƒç√≠st do ACE editoru
                            inputEditor.setValue(ev.target.result, -1);
                            formatJsonInEditor(inputEditor);
                            VisualEditor.switchMode('input', 'code');
                        }
                    };
                    reader.readAsText(file);
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const plan = JSON.parse(ev.target.result);
                            // Naƒç√≠st do vizu√°ln√≠ho editoru
                            VisualEditor.loadPlan('input', plan);
                        } catch (err) {
                            // P≈ôi chybƒõ naƒç√≠st do ACE editoru
                            inputEditor.setValue(ev.target.result, -1);
                            formatJsonInEditor(inputEditor);
                            VisualEditor.switchMode('input', 'code');
                        }
                    };
                    reader.readAsText(file);
                }
            });

            // Auto-format p≈ôi paste
            inputEditor.on('paste', () => {
                setTimeout(() => formatJsonInEditor(inputEditor), 10);
            });

            editorEditor.on('paste', () => {
                setTimeout(() => formatJsonInEditor(editorEditor), 10);
            });

            // Recovery modal
            document.getElementById('recoverBtn').addEventListener('click', () => {
                const plan = loadPlanFromStorage();
                hideModal(recoveryModal);
                if (plan) {
                    renderPlan(plan);
                } else {
                    showModal(inputModal);
                }
            });

            document.getElementById('startNewBtn').addEventListener('click', () => {
                clearStorage();
                hideModal(recoveryModal);
                showModal(inputModal);
            });

            // Action buttons
            document.getElementById('shareBtn').addEventListener('click', () => {
                const url = getShareURL();
                if (url) {
                    navigator.clipboard.writeText(url).then(() => {
                        showToast(t('toast.copied'));
                    });
                }
            });

            document.getElementById('editJsonBtn').addEventListener('click', () => {
                VisualEditor.loadPlan('editor', currentPlan);
                editorErrorSummary.classList.remove('visible');
                editorJsonContainer.classList.remove('has-error');
                showModal(editorModal);
            });

            // Export dropdown
            document.getElementById('exportBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                exportDropdown.classList.toggle('open');
            });

            // Zav≈ô√≠t dropdown p≈ôi kliknut√≠ jinam
            document.addEventListener('click', (e) => {
                if (!exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('open');
                }
            });

            // Export PNG - cel√© UI
            document.getElementById('exportPngBtn').addEventListener('click', async () => {
                exportDropdown.classList.remove('open');
                showToast(t('toast.exportStarted'));

                // Poƒçkat na naƒçten√≠ v≈°ech dla≈ædic
                const mapEl = document.getElementById('map');
                await new Promise(resolve => {
                    const checkTiles = () => {
                        const tiles = mapEl.querySelectorAll('.leaflet-tile');
                        const loading = Array.from(tiles).filter(t => !t.complete);
                        if (loading.length === 0) resolve();
                        else setTimeout(checkTiles, 100);
                    };
                    checkTiles();
                });

                // Kr√°tk√° pauza pro dokonƒçen√≠ renderov√°n√≠
                await new Promise(r => setTimeout(r, 300));

                // Zastavit animace
                leafletMap.stop();

                try {
                    // Exportovat cel√Ω container (mapa + sidebar)
                    const container = document.querySelector('.container');
                    const rect = container.getBoundingClientRect();

                    const canvas = await html2canvas(container, {
                        useCORS: true,
                        allowTaint: false,
                        backgroundColor: '#ffffff',
                        scale: 1,
                        width: rect.width,
                        height: rect.height,
                        scrollX: -window.scrollX,
                        scrollY: -window.scrollY,
                        windowWidth: document.documentElement.clientWidth,
                        windowHeight: document.documentElement.clientHeight,
                        ignoreElements: (el) => {
                            // Ignorovat dropdown, toast, modaly
                            return el.classList.contains('dropdown-content') ||
                                   el.classList.contains('toast') ||
                                   el.classList.contains('modal-overlay') ||
                                   el.classList.contains('mobile-toggle') ||
                                   el.classList.contains('warning-message');
                        }
                    });

                    const parsed = parseNameWithEmoji(currentPlan?.name || 'mapa');
                    const link = document.createElement('a');
                    link.download = `${parsed.name}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    showToast(t('toast.exportDone'));
                } catch (err) {
                    console.error(err);
                    showToast(t('toast.exportFailed'));
                }
            });

            // Tisk
            document.getElementById('printBtn').addEventListener('click', () => {
                exportDropdown.classList.remove('open');
                window.print();
            });

            // Editor modal
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                if (VisualEditor.hasUnsavedChanges('editor')) {
                    if (!confirm('M√°te neulo≈æen√© zmƒõny. Opravdu chcete zav≈ô√≠t editor?')) {
                        return;
                    }
                }
                VisualEditor.clearDraft('editor');
                hideModal(editorModal);
            });

            document.getElementById('copyJsonBtn').addEventListener('click', () => {
                // Zajistit aktu√°ln√≠ JSON
                const plan = VisualEditor.getPlan('editor');
                const json = plan ? JSON.stringify(plan, null, 2) : editorEditor.getValue();
                navigator.clipboard.writeText(json).then(() => {
                    showToast(t('toast.jsonCopied'));
                });
            });

            document.getElementById('saveJsonBtn').addEventListener('click', () => {
                const plan = VisualEditor.getPlan('editor');

                if (!plan) {
                    showErrors([t('errors.invalidJson')], editorErrorSummary, editorErrorList, editorJsonContainer);
                    return;
                }

                const errors = validatePlan(plan);
                if (showErrors(errors, editorErrorSummary, editorErrorList, editorJsonContainer)) {
                    return;
                }

                VisualEditor.clearDraft('editor');
                hideModal(editorModal);
                renderPlan(plan);
                showToast(t('toast.saved'));
            });

            // Controls
            document.getElementById('showRoutes').addEventListener('change', function() {
                const line = routeLine;
                if (this.checked) {
                    if (line && !leafletMap.hasLayer(line)) line.addTo(leafletMap);
                } else {
                    if (line && leafletMap.hasLayer(line)) leafletMap.removeLayer(line);
                }
            });

            document.getElementById('showLabels').addEventListener('change', function() {
                labels.forEach(lbl => {
                    if (this.checked) {
                        if (!leafletMap.hasLayer(lbl)) lbl.addTo(leafletMap);
                    } else {
                        if (leafletMap.hasLayer(lbl)) leafletMap.removeLayer(lbl);
                    }
                });
            });

            // Mobile toggle
            mobileToggle.addEventListener('click', () => {
                sidebar.classList.toggle('visible');
                mobileToggle.textContent = sidebar.classList.contains('visible') ? 'Zobrazit mapu' : 'Zobrazit seznam';
            });
        }

        // =====================
        // Map Picker Module
        // =====================
        const MapPicker = (function() {
            let overlay = null;
            let pickerMap = null;
            let marker = null;
            let selectedLat = null;
            let selectedLng = null;
            let onConfirmCallback = null;
            let searchTimeout = null;

            function createOverlay() {
                const html = `
                    <div class="map-picker-overlay" id="mapPickerOverlay">
                        <div class="map-picker-header">
                            <div class="map-picker-search" style="position: relative;">
                                <input type="text" id="mapPickerSearchInput" placeholder="Hledat m√≠sto...">
                                <div class="map-picker-search-results" id="mapPickerSearchResults"></div>
                            </div>
                            <button class="btn btn-secondary" id="mapPickerCancelBtn">Zru≈°it</button>
                        </div>
                        <div class="map-picker-body">
                            <div id="pickerMap"></div>
                        </div>
                        <div class="map-picker-footer">
                            <div class="map-picker-coords" id="mapPickerCoords">
                                Kliknƒõte na mapu pro v√Ωbƒõr m√≠sta
                            </div>
                            <div class="map-picker-actions">
                                <button class="btn btn-primary" id="mapPickerConfirmBtn" disabled>Potvrdit</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
                overlay = document.getElementById('mapPickerOverlay');

                // Initialize map
                pickerMap = L.map('pickerMap').setView([50, 15], 5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(pickerMap);

                // Map click handler
                pickerMap.on('click', (e) => {
                    setMarker(e.latlng.lat, e.latlng.lng);
                });

                // Cancel button
                document.getElementById('mapPickerCancelBtn').addEventListener('click', close);

                // Confirm button
                document.getElementById('mapPickerConfirmBtn').addEventListener('click', () => {
                    if (selectedLat !== null && selectedLng !== null && onConfirmCallback) {
                        onConfirmCallback(selectedLat, selectedLng);
                    }
                    close();
                });

                // Search input
                const searchInput = document.getElementById('mapPickerSearchInput');
                const searchResults = document.getElementById('mapPickerSearchResults');

                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();

                    if (query.length < 2) {
                        searchResults.classList.remove('visible');
                        return;
                    }

                    searchTimeout = setTimeout(() => {
                        searchPlaces(query);
                    }, 300);
                });

                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        searchResults.classList.remove('visible');
                    }
                });

                // Close search results on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.map-picker-search')) {
                        searchResults.classList.remove('visible');
                    }
                });
            }

            function setMarker(lat, lng) {
                selectedLat = lat;
                selectedLng = lng;

                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], {
                        draggable: true
                    }).addTo(pickerMap);

                    marker.on('dragend', () => {
                        const pos = marker.getLatLng();
                        selectedLat = pos.lat;
                        selectedLng = pos.lng;
                        updateCoordsDisplay();
                    });
                }

                updateCoordsDisplay();
                document.getElementById('mapPickerConfirmBtn').disabled = false;
            }

            function updateCoordsDisplay() {
                const coords = document.getElementById('mapPickerCoords');
                if (selectedLat !== null && selectedLng !== null) {
                    coords.innerHTML = `<strong>Lat:</strong> ${selectedLat.toFixed(6)} &nbsp; <strong>Lng:</strong> ${selectedLng.toFixed(6)}`;
                }
            }

            async function searchPlaces(query) {
                const results = document.getElementById('mapPickerSearchResults');

                try {
                    const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`);
                    const data = await response.json();

                    if (data.features && data.features.length > 0) {
                        results.innerHTML = data.features.map(f => {
                            const props = f.properties;
                            const name = props.name || '';
                            const city = props.city || props.county || '';
                            const country = props.country || '';
                            const display = [name, city, country].filter(Boolean).join(', ');

                            return `<div class="map-picker-search-result" data-lat="${f.geometry.coordinates[1]}" data-lng="${f.geometry.coordinates[0]}">${display}</div>`;
                        }).join('');

                        results.querySelectorAll('.map-picker-search-result').forEach(item => {
                            item.addEventListener('click', () => {
                                const lat = parseFloat(item.dataset.lat);
                                const lng = parseFloat(item.dataset.lng);
                                setMarker(lat, lng);
                                pickerMap.setView([lat, lng], 14);
                                results.classList.remove('visible');
                                document.getElementById('mapPickerSearchInput').value = item.textContent;
                            });
                        });

                        results.classList.add('visible');
                    } else {
                        results.innerHTML = '<div class="map-picker-search-result">Nic nenalezeno</div>';
                        results.classList.add('visible');
                    }
                } catch (e) {
                    results.innerHTML = '<div class="map-picker-search-result">Chyba p≈ôi hled√°n√≠</div>';
                    results.classList.add('visible');
                }
            }

            function open(lat, lng, callback) {
                if (!overlay) createOverlay();

                selectedLat = null;
                selectedLng = null;
                onConfirmCallback = callback;

                // Clear previous marker
                if (marker) {
                    pickerMap.removeLayer(marker);
                    marker = null;
                }

                // Reset UI
                document.getElementById('mapPickerSearchInput').value = '';
                document.getElementById('mapPickerSearchResults').classList.remove('visible');
                document.getElementById('mapPickerCoords').textContent = 'Kliknƒõte na mapu pro v√Ωbƒõr m√≠sta';
                document.getElementById('mapPickerConfirmBtn').disabled = true;

                // Set initial position if provided
                if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                    setMarker(lat, lng);
                    pickerMap.setView([lat, lng], 12);
                } else {
                    pickerMap.setView([50, 15], 5);
                }

                overlay.classList.add('visible');

                // Fix map size after display
                setTimeout(() => {
                    pickerMap.invalidateSize();
                }, 100);
            }

            function close() {
                if (overlay) {
                    overlay.classList.remove('visible');
                }
            }

            return { open, close };
        })();

        // =====================
        // Visual Editor Module
        // =====================
        const VisualEditor = (function() {
            // State
            let currentMode = { input: 'visual', editor: 'visual' };
            let undoStack = { input: [], editor: [] };
            let redoStack = { input: [], editor: [] };
            let lastSyncedData = { input: null, editor: null };
            let customFields = { input: {}, editor: {} }; // Store unknown JSON fields
            let draftKey = 'planpresso-draft-v1';
            let syncTimeout = null;
            let draggedItem = null;

            // DOM elements (set during init)
            const elements = {
                input: {},
                editor: {}
            };

            // Debounce helper
            function debounce(fn, delay) {
                let timer;
                return function(...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            // Escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Format date for input[type=date]
            function formatDateForInput(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return '';
                return d.toISOString().split('T')[0];
            }

            // Parse markdown (simple)
            function parseMarkdown(text) {
                if (!text) return '';
                return text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/_(.+?)_/g, '<em>$1</em>')
                    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/^- (.+)$/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
            }

            // Calculate nights
            function calcNights(from, to) {
                if (!from || !to) return 0;
                const f = new Date(from);
                const t = new Date(to);
                if (isNaN(f.getTime()) || isNaN(t.getTime())) return 0;
                return Math.max(0, Math.round((t - f) / (1000 * 60 * 60 * 24)));
            }

            // Format date range short
            function formatDateShort(from, to) {
                if (!from && !to) return '';
                const opts = { day: 'numeric', month: 'short' };
                if (from && to) {
                    return `${new Date(from).toLocaleDateString('cs', opts)} ‚Äì ${new Date(to).toLocaleDateString('cs', opts)}`;
                }
                return new Date(from || to).toLocaleDateString('cs', opts);
            }

            // Check if stop is complete (has required fields)
            function isStopComplete(stop) {
                return stop.name && stop.lat != null && stop.lng != null && !isNaN(stop.lat) && !isNaN(stop.lng);
            }

            // Get visual data from form
            function getVisualData(ctx) {
                const el = elements[ctx];
                const stops = [];

                el.stopsList.querySelectorAll('.stop-item').forEach(item => {
                    const stop = {
                        name: item.querySelector('.stop-name')?.value.trim() || '',
                        lat: parseFloat(item.querySelector('.stop-lat')?.value) || null,
                        lng: parseFloat(item.querySelector('.stop-lng')?.value) || null
                    };

                    const label = item.querySelector('.stop-label')?.value.trim();
                    const dateFrom = item.querySelector('.stop-dateFrom')?.value;
                    const dateTo = item.querySelector('.stop-dateTo')?.value;
                    const notes = item.querySelector('.stop-notes')?.value.trim();
                    const imageUrl = item.querySelector('.stop-imageUrl')?.value.trim();

                    if (label) stop.label = label;
                    if (dateFrom) stop.dateFrom = dateFrom;
                    if (dateTo) stop.dateTo = dateTo;
                    if (notes) stop.notes = notes;
                    if (imageUrl) stop.imageUrl = imageUrl;

                    // Restore custom fields for this stop
                    const idx = parseInt(item.dataset.stopIndex);
                    if (customFields[ctx][idx]) {
                        Object.assign(stop, customFields[ctx][idx]);
                    }

                    stops.push(stop);
                });

                const plan = {
                    name: el.planName?.value.trim() || '',
                    stops: stops
                };

                const dateFrom = el.planDateFrom?.value;
                const dateTo = el.planDateTo?.value;
                if (dateFrom) plan.dateFrom = dateFrom;
                if (dateTo) plan.dateTo = dateTo;

                return plan;
            }

            // Set visual data to form
            function setVisualData(ctx, plan) {
                const el = elements[ctx];
                if (!el.planName) return;

                // Reset custom fields storage
                customFields[ctx] = {};

                // Set plan metadata
                el.planName.value = plan.name || '';
                el.planDateFrom.value = formatDateForInput(plan.dateFrom);
                el.planDateTo.value = formatDateForInput(plan.dateTo);

                // Clear stops list
                el.stopsList.innerHTML = '';

                if (plan.stops && plan.stops.length > 0) {
                    plan.stops.forEach((stop, index) => {
                        // Store unknown fields
                        const knownFields = ['name', 'lat', 'lng', 'label', 'dateFrom', 'dateTo', 'notes', 'imageUrl'];
                        const custom = {};
                        Object.keys(stop).forEach(key => {
                            if (!knownFields.includes(key)) {
                                custom[key] = stop[key];
                            }
                        });
                        if (Object.keys(custom).length > 0) {
                            customFields[ctx][index] = custom;
                        }

                        addStopItem(ctx, stop, index, false);
                    });
                } else {
                    renderEmptyState(ctx);
                }

                updateStats(ctx);
                updateStopNumbers(ctx);
            }

            // Sync visual to code
            function syncVisualToCode(ctx) {
                const plan = getVisualData(ctx);
                const editor = ctx === 'input' ? inputEditor : editorEditor;
                const json = JSON.stringify(plan, null, 2);
                editor.setValue(json, -1);
                lastSyncedData[ctx] = json;
            }

            // Sync code to visual
            function syncCodeToVisual(ctx) {
                const editor = ctx === 'input' ? inputEditor : editorEditor;
                try {
                    const plan = JSON.parse(editor.getValue());
                    setVisualData(ctx, plan);
                    lastSyncedData[ctx] = editor.getValue();
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // Debounced sync
            const debouncedSync = debounce(function(ctx) {
                syncVisualToCode(ctx);
                saveDraft(ctx);
            }, 500);

            // Save undo state
            function saveUndoState(ctx) {
                const data = JSON.stringify(getVisualData(ctx));
                if (undoStack[ctx].length === 0 || undoStack[ctx][undoStack[ctx].length - 1] !== data) {
                    undoStack[ctx].push(data);
                    if (undoStack[ctx].length > 50) undoStack[ctx].shift();
                    redoStack[ctx] = [];
                }
            }

            // Undo
            function undo(ctx) {
                if (undoStack[ctx].length > 1) {
                    redoStack[ctx].push(undoStack[ctx].pop());
                    const data = JSON.parse(undoStack[ctx][undoStack[ctx].length - 1]);
                    setVisualData(ctx, data);
                    syncVisualToCode(ctx);
                }
            }

            // Redo
            function redo(ctx) {
                if (redoStack[ctx].length > 0) {
                    const data = JSON.parse(redoStack[ctx].pop());
                    undoStack[ctx].push(JSON.stringify(data));
                    setVisualData(ctx, data);
                    syncVisualToCode(ctx);
                }
            }

            // Clear undo history
            function clearUndoHistory(ctx) {
                undoStack[ctx] = [];
                redoStack[ctx] = [];
            }

            // Save draft to localStorage
            function saveDraft(ctx) {
                try {
                    const data = getVisualData(ctx);
                    localStorage.setItem(`${draftKey}-${ctx}`, JSON.stringify({
                        data,
                        timestamp: Date.now()
                    }));
                } catch (e) { }
            }

            // Load draft from localStorage
            function loadDraft(ctx) {
                try {
                    const saved = localStorage.getItem(`${draftKey}-${ctx}`);
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) { }
                return null;
            }

            // Clear draft
            function clearDraft(ctx) {
                try {
                    localStorage.removeItem(`${draftKey}-${ctx}`);
                } catch (e) { }
            }

            // Check for unsaved changes
            function hasUnsavedChanges(ctx) {
                const current = JSON.stringify(getVisualData(ctx));
                return current !== lastSyncedData[ctx];
            }

            // Update statistics
            function updateStats(ctx) {
                const el = elements[ctx];
                if (!el.statsStops || !el.statsNights) return;

                const stops = el.stopsList.querySelectorAll('.stop-item');
                let totalNights = 0;

                stops.forEach(item => {
                    const from = item.querySelector('.stop-dateFrom')?.value;
                    const to = item.querySelector('.stop-dateTo')?.value;
                    totalNights += calcNights(from, to);
                });

                el.statsStops.textContent = stops.length;
                el.statsNights.textContent = totalNights;
            }

            // Update stop numbers
            function updateStopNumbers(ctx) {
                const el = elements[ctx];
                el.stopsList.querySelectorAll('.stop-item').forEach((item, idx) => {
                    item.dataset.stopIndex = idx;
                    const num = item.querySelector('.stop-item-number');
                    if (num) num.textContent = idx + 1;
                });
            }

            // Create stop item HTML
            function createStopItemHTML(stop, index) {
                const title = stop.name || stop.label || 'Nov√° zast√°vka';
                const isEmpty = !stop.name;
                const dates = formatDateShort(stop.dateFrom, stop.dateTo);
                const nights = calcNights(stop.dateFrom, stop.dateTo);
                const complete = isStopComplete(stop);

                return `
                    <div class="stop-item" data-stop-index="${index}" draggable="true">
                        <div class="stop-item-header">
                            <div class="stop-item-drag-handle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="16" y2="6"></line>
                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                    <line x1="8" y1="18" x2="16" y2="18"></line>
                                </svg>
                            </div>
                            <div class="stop-item-reorder">
                                <button type="button" class="stop-item-btn move-up" title="Posunout nahoru">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                </button>
                                <button type="button" class="stop-item-btn move-down" title="Posunout dol≈Ø">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <span class="stop-item-number">${index + 1}</span>
                            <div class="stop-item-info">
                                <div class="stop-item-title ${isEmpty ? 'empty' : ''}">${escapeHtml(title)}</div>
                                ${dates ? `<div class="stop-item-subtitle">${dates}${nights > 0 ? ` ¬∑ ${nights} ${nights === 1 ? 'noc' : nights < 5 ? 'noci' : 'noc√≠'}` : ''}</div>` : ''}
                            </div>
                            <div class="stop-item-status ${complete ? 'complete' : 'incomplete'}" title="${complete ? 'Kompletn√≠' : 'Chyb√≠ povinn√° pole'}"></div>
                            <div class="stop-item-actions">
                                <button type="button" class="stop-item-btn duplicate" title="Duplikovat">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                <button type="button" class="stop-item-btn delete" title="Smazat">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                                <button type="button" class="stop-item-btn stop-item-toggle" aria-expanded="false">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="stop-item-content" hidden>
                            <div class="form-group">
                                <label>N√°zev *</label>
                                <input type="text" class="form-input stop-name" placeholder="nap≈ô. Praha - Star√© Mƒõsto" value="${escapeHtml(stop.name || '')}">
                            </div>
                            <div class="form-group">
                                <label>Zkr√°cen√Ω popisek</label>
                                <input type="text" class="form-input stop-label" placeholder="nap≈ô. Praha" value="${escapeHtml(stop.label || '')}">
                            </div>
                            <div class="coords-row">
                                <div class="form-group">
                                    <label>Zemƒõpisn√° ≈°√≠≈ôka *</label>
                                    <input type="number" class="form-input stop-lat" step="any" placeholder="nap≈ô. 50.0875" value="${stop.lat ?? ''}">
                                </div>
                                <div class="form-group">
                                    <label>Zemƒõpisn√° d√©lka *</label>
                                    <input type="number" class="form-input stop-lng" step="any" placeholder="nap≈ô. 14.4214" value="${stop.lng ?? ''}">
                                </div>
                                <button type="button" class="btn-map-picker" title="Vybrat na mapƒõ">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </button>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Datum od</label>
                                    <input type="date" class="form-input stop-dateFrom" value="${formatDateForInput(stop.dateFrom)}">
                                </div>
                                <div class="form-group">
                                    <label>Datum do</label>
                                    <input type="date" class="form-input stop-dateTo" value="${formatDateForInput(stop.dateTo)}">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="notes-header">
                                    <label>Pozn√°mky</label>
                                    <button type="button" class="btn-preview-toggle">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        N√°hled
                                    </button>
                                </div>
                                <textarea class="form-input form-textarea stop-notes" rows="2" placeholder="Voliteln√© pozn√°mky (podporuje Markdown)">${escapeHtml(stop.notes || '')}</textarea>
                                <div class="markdown-preview" style="display: none;"></div>
                            </div>
                            <div class="form-group">
                                <label>URL obr√°zku</label>
                                <input type="text" class="form-input stop-imageUrl" placeholder="https://..." value="${escapeHtml(stop.imageUrl || '')}">
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add stop item
            function addStopItem(ctx, stop = {}, index = null, expand = true) {
                const el = elements[ctx];

                // Remove empty state
                const emptyState = el.stopsList.querySelector('.stops-list-empty');
                if (emptyState) emptyState.remove();

                if (index === null) {
                    index = el.stopsList.querySelectorAll('.stop-item').length;
                }

                const template = document.createElement('template');
                template.innerHTML = createStopItemHTML(stop, index);
                const item = template.content.firstElementChild;

                el.stopsList.appendChild(item);
                setupStopItemEvents(ctx, item);

                if (expand && !stop.name) {
                    toggleStopItem(item, true);
                    setTimeout(() => item.querySelector('.stop-name')?.focus(), 50);
                }

                updateStopNumbers(ctx);
                updateStats(ctx);

                return item;
            }

            // Remove stop item
            function removeStopItem(ctx, item) {
                saveUndoState(ctx);
                item.remove();

                const el = elements[ctx];
                if (el.stopsList.querySelectorAll('.stop-item').length === 0) {
                    renderEmptyState(ctx);
                }

                updateStopNumbers(ctx);
                updateStats(ctx);
                debouncedSync(ctx);
            }

            // Duplicate stop item
            function duplicateStopItem(ctx, item) {
                saveUndoState(ctx);

                const stop = {
                    name: item.querySelector('.stop-name')?.value || '',
                    label: item.querySelector('.stop-label')?.value || '',
                    lat: parseFloat(item.querySelector('.stop-lat')?.value) || null,
                    lng: parseFloat(item.querySelector('.stop-lng')?.value) || null,
                    dateFrom: item.querySelector('.stop-dateFrom')?.value || '',
                    dateTo: item.querySelector('.stop-dateTo')?.value || '',
                    notes: item.querySelector('.stop-notes')?.value || '',
                    imageUrl: item.querySelector('.stop-imageUrl')?.value || ''
                };

                // Clean empty values
                Object.keys(stop).forEach(key => {
                    if (stop[key] === '' || stop[key] === null) delete stop[key];
                });

                const newItem = addStopItem(ctx, stop, null, true);
                item.after(newItem);
                updateStopNumbers(ctx);
                debouncedSync(ctx);
            }

            // Toggle stop item accordion
            function toggleStopItem(item, forceExpand = null) {
                const content = item.querySelector('.stop-item-content');
                const toggle = item.querySelector('.stop-item-toggle');
                const isExpanded = !content.hidden;

                const shouldExpand = forceExpand !== null ? forceExpand : !isExpanded;

                if (shouldExpand) {
                    content.hidden = false;
                    item.classList.add('expanded');
                    toggle?.setAttribute('aria-expanded', 'true');
                } else {
                    content.hidden = true;
                    item.classList.remove('expanded');
                    toggle?.setAttribute('aria-expanded', 'false');
                }
            }

            // Render empty state
            function renderEmptyState(ctx) {
                const el = elements[ctx];
                el.stopsList.innerHTML = `
                    <div class="stops-list-empty">
                        ≈Ω√°dn√© zast√°vky. Kliknƒõte na "P≈ôidat zast√°vku" pro zaƒç√°tek.
                    </div>
                `;
            }

            // Move stop (reorder)
            function moveStop(ctx, fromIndex, toIndex, dateAction = 'none') {
                const el = elements[ctx];
                const items = Array.from(el.stopsList.querySelectorAll('.stop-item'));

                if (fromIndex < 0 || fromIndex >= items.length || toIndex < 0 || toIndex >= items.length) {
                    return;
                }

                saveUndoState(ctx);

                const item = items[fromIndex];

                if (toIndex < fromIndex) {
                    items[toIndex].before(item);
                } else {
                    items[toIndex].after(item);
                }

                // Handle date adjustment if needed
                if (dateAction === 'shift') {
                    adjustDatesAfterReorder(ctx);
                } else if (dateAction === 'fix') {
                    fixDateOverlaps(ctx);
                }

                updateStopNumbers(ctx);
                debouncedSync(ctx);
            }

            // Adjust dates after reorder (shift relatively)
            function adjustDatesAfterReorder(ctx) {
                const el = elements[ctx];
                const items = Array.from(el.stopsList.querySelectorAll('.stop-item'));
                let prevDateTo = null;

                items.forEach(item => {
                    const fromInput = item.querySelector('.stop-dateFrom');
                    const toInput = item.querySelector('.stop-dateTo');

                    if (prevDateTo && fromInput?.value) {
                        const from = new Date(fromInput.value);
                        const to = toInput?.value ? new Date(toInput.value) : null;
                        const duration = to ? calcNights(fromInput.value, toInput.value) : 0;

                        // Set new from date to day after previous to
                        const newFrom = new Date(prevDateTo);
                        newFrom.setDate(newFrom.getDate());
                        fromInput.value = newFrom.toISOString().split('T')[0];

                        if (to && duration > 0) {
                            const newTo = new Date(newFrom);
                            newTo.setDate(newTo.getDate() + duration);
                            toInput.value = newTo.toISOString().split('T')[0];
                        }
                    }

                    if (toInput?.value) {
                        prevDateTo = new Date(toInput.value);
                    }
                });
            }

            // Fix date overlaps only
            function fixDateOverlaps(ctx) {
                const el = elements[ctx];
                const items = Array.from(el.stopsList.querySelectorAll('.stop-item'));
                let prevDateTo = null;

                items.forEach(item => {
                    const fromInput = item.querySelector('.stop-dateFrom');
                    const toInput = item.querySelector('.stop-dateTo');

                    if (prevDateTo && fromInput?.value) {
                        const from = new Date(fromInput.value);
                        if (from < prevDateTo) {
                            fromInput.value = prevDateTo.toISOString().split('T')[0];
                        }
                    }

                    if (toInput?.value) {
                        prevDateTo = new Date(toInput.value);
                    }
                });
            }

            // Show reorder dialog
            function showReorderDialog(ctx, fromIndex, toIndex) {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('reorderDialogOverlay');
                    if (!overlay) {
                        resolve('none');
                        return;
                    }

                    overlay.classList.add('visible');

                    const handleOption = (action) => {
                        overlay.classList.remove('visible');
                        overlay.querySelectorAll('.reorder-dialog-option').forEach(btn => {
                            btn.removeEventListener('click', btn._handler);
                        });
                        resolve(action);
                    };

                    overlay.querySelectorAll('.reorder-dialog-option').forEach(btn => {
                        btn._handler = () => handleOption(btn.dataset.action);
                        btn.addEventListener('click', btn._handler);
                    });
                });
            }

            // Setup stop item events
            function setupStopItemEvents(ctx, item) {
                // Header click (toggle)
                item.querySelector('.stop-item-header').addEventListener('click', (e) => {
                    if (e.target.closest('.stop-item-btn') || e.target.closest('.stop-item-drag-handle') || e.target.closest('.stop-item-reorder')) {
                        return;
                    }
                    toggleStopItem(item);
                });

                // Delete button
                item.querySelector('.stop-item-btn.delete')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Opravdu chcete smazat tuto zast√°vku?')) {
                        removeStopItem(ctx, item);
                    }
                });

                // Duplicate button
                item.querySelector('.stop-item-btn.duplicate')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    duplicateStopItem(ctx, item);
                });

                // Move up/down buttons
                item.querySelector('.move-up')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(item.dataset.stopIndex);
                    if (idx > 0) {
                        showReorderDialog(ctx, idx, idx - 1).then(action => {
                            moveStop(ctx, idx, idx - 1, action);
                        });
                    }
                });

                item.querySelector('.move-down')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(item.dataset.stopIndex);
                    const el = elements[ctx];
                    const count = el.stopsList.querySelectorAll('.stop-item').length;
                    if (idx < count - 1) {
                        showReorderDialog(ctx, idx, idx + 1).then(action => {
                            moveStop(ctx, idx, idx + 1, action);
                        });
                    }
                });

                // Map picker button
                item.querySelector('.btn-map-picker')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const lat = parseFloat(item.querySelector('.stop-lat')?.value) || null;
                    const lng = parseFloat(item.querySelector('.stop-lng')?.value) || null;
                    MapPicker.open(lat, lng, (newLat, newLng) => {
                        item.querySelector('.stop-lat').value = newLat.toFixed(6);
                        item.querySelector('.stop-lng').value = newLng.toFixed(6);
                        updateStopHeader(item);
                        debouncedSync(ctx);
                    });
                });

                // Preview toggle
                item.querySelector('.btn-preview-toggle')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const btn = e.currentTarget;
                    const textarea = item.querySelector('.stop-notes');
                    const preview = item.querySelector('.markdown-preview');

                    if (preview.style.display === 'none') {
                        preview.innerHTML = parseMarkdown(textarea.value) || '<em>≈Ω√°dn√© pozn√°mky</em>';
                        preview.style.display = 'block';
                        textarea.style.display = 'none';
                        btn.classList.add('active');
                    } else {
                        preview.style.display = 'none';
                        textarea.style.display = 'block';
                        btn.classList.remove('active');
                    }
                });

                // Input changes
                const inputs = item.querySelectorAll('.form-input');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        updateStopHeader(item);
                        debouncedSync(ctx);
                    });

                    input.addEventListener('blur', () => {
                        // Real-time validation on blur
                        validateStopField(input);
                    });

                    input.addEventListener('change', () => {
                        saveUndoState(ctx);
                        updateStats(ctx);
                    });
                });

                // Drag and drop
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', item.dataset.stopIndex);
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    draggedItem = null;
                    elements[ctx].stopsList.querySelectorAll('.drag-over').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (draggedItem && item !== draggedItem) {
                        elements[ctx].stopsList.querySelectorAll('.drag-over').forEach(el => {
                            if (el !== item) el.classList.remove('drag-over');
                        });
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', (e) => {
                    if (!item.contains(e.relatedTarget)) {
                        item.classList.remove('drag-over');
                    }
                });

                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');

                    if (!draggedItem || item === draggedItem) return;

                    const fromIndex = parseInt(draggedItem.dataset.stopIndex);
                    const toIndex = parseInt(item.dataset.stopIndex);

                    const action = await showReorderDialog(ctx, fromIndex, toIndex);
                    moveStop(ctx, fromIndex, toIndex, action);
                });
            }

            // Update stop header from inputs
            function updateStopHeader(item) {
                const name = item.querySelector('.stop-name')?.value || '';
                const label = item.querySelector('.stop-label')?.value || '';
                const dateFrom = item.querySelector('.stop-dateFrom')?.value || '';
                const dateTo = item.querySelector('.stop-dateTo')?.value || '';

                const title = item.querySelector('.stop-item-title');
                const subtitle = item.querySelector('.stop-item-subtitle');
                const status = item.querySelector('.stop-item-status');

                const displayName = name || label || 'Nov√° zast√°vka';
                title.textContent = displayName;
                title.classList.toggle('empty', !name && !label);

                const dates = formatDateShort(dateFrom, dateTo);
                const nights = calcNights(dateFrom, dateTo);
                if (subtitle) {
                    subtitle.textContent = dates ? `${dates}${nights > 0 ? ` ¬∑ ${nights} ${nights === 1 ? 'noc' : nights < 5 ? 'noci' : 'noc√≠'}` : ''}` : '';
                }

                const lat = parseFloat(item.querySelector('.stop-lat')?.value);
                const lng = parseFloat(item.querySelector('.stop-lng')?.value);
                const complete = name && !isNaN(lat) && !isNaN(lng);
                if (status) {
                    status.classList.toggle('complete', complete);
                    status.classList.toggle('incomplete', !complete);
                    status.title = complete ? 'Kompletn√≠' : 'Chyb√≠ povinn√° pole';
                }
            }

            // Validate stop field
            function validateStopField(input) {
                const value = input.value;
                let hasError = false;

                if (input.classList.contains('stop-lat')) {
                    const lat = parseFloat(value);
                    hasError = value && (isNaN(lat) || lat < -90 || lat > 90);
                } else if (input.classList.contains('stop-lng')) {
                    const lng = parseFloat(value);
                    hasError = value && (isNaN(lng) || lng < -180 || lng > 180);
                }

                input.classList.toggle('has-error', hasError);
            }

            // Switch mode
            function switchMode(ctx, mode) {
                const el = elements[ctx];

                if (mode === 'visual') {
                    // Try to sync code to visual
                    if (!syncCodeToVisual(ctx)) {
                        // Invalid JSON - block switch
                        showToast('JSON obsahuje chyby. Opravte je p≈ôed p≈ôepnut√≠m.');
                        return false;
                    }
                    clearUndoHistory(ctx);
                    saveUndoState(ctx);
                } else {
                    // Sync visual to code
                    syncVisualToCode(ctx);
                    clearUndoHistory(ctx);
                }

                currentMode[ctx] = mode;

                // Update tabs
                el.tabs.querySelectorAll('.editor-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === mode);
                });

                // Show/hide editors
                el.visualEditor.style.display = mode === 'visual' ? 'block' : 'none';
                el.codeEditor.classList.toggle('active', mode === 'code');

                return true;
            }

            // Setup context events
            function setupContextEvents(ctx) {
                const el = elements[ctx];

                // Tab switching
                el.tabs?.addEventListener('click', (e) => {
                    const tab = e.target.closest('.editor-tab');
                    if (tab && !tab.classList.contains('active')) {
                        switchMode(ctx, tab.dataset.mode);
                    }
                });

                // Add stop button
                el.addStopBtn?.addEventListener('click', () => {
                    saveUndoState(ctx);
                    addStopItem(ctx, {}, null, true);
                    debouncedSync(ctx);
                });

                // Plan metadata inputs
                [el.planName, el.planDateFrom, el.planDateTo].forEach(input => {
                    if (input) {
                        input.addEventListener('input', () => debouncedSync(ctx));
                        input.addEventListener('change', () => saveUndoState(ctx));
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Only handle if modal is visible and visual editor is active
                    const modal = ctx === 'input' ? inputModal : editorModal;
                    if (!modal.classList.contains('visible')) return;
                    if (currentMode[ctx] !== 'visual') return;

                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const ctrlKey = isMac ? e.metaKey : e.ctrlKey;

                    if (ctrlKey && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo(ctx);
                    } else if (ctrlKey && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                        e.preventDefault();
                        redo(ctx);
                    } else if (ctrlKey && e.key === 'n') {
                        e.preventDefault();
                        saveUndoState(ctx);
                        addStopItem(ctx, {}, null, true);
                        debouncedSync(ctx);
                    } else if (ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        const focused = document.activeElement?.closest('.stop-item');
                        if (focused) {
                            duplicateStopItem(ctx, focused);
                        }
                    }
                });
            }

            // Initialize
            function init(ctx, prefix) {
                const modal = document.getElementById(`${prefix}Modal`);
                if (!modal) return;

                elements[ctx] = {
                    tabs: modal.querySelector('.editor-tabs'),
                    visualEditor: modal.querySelector('.visual-editor'),
                    codeEditor: modal.querySelector('.code-editor'),
                    planName: modal.querySelector(`#${prefix}PlanName`),
                    planDateFrom: modal.querySelector(`#${prefix}PlanDateFrom`),
                    planDateTo: modal.querySelector(`#${prefix}PlanDateTo`),
                    stopsList: modal.querySelector(`#${prefix}StopsList`),
                    addStopBtn: modal.querySelector(`#${prefix}AddStopBtn`),
                    statsStops: modal.querySelector(`#${prefix}StatsStops`),
                    statsNights: modal.querySelector(`#${prefix}StatsNights`)
                };

                setupContextEvents(ctx);

                // Initial empty state
                if (elements[ctx].stopsList && elements[ctx].stopsList.children.length === 0) {
                    renderEmptyState(ctx);
                }
            }

            // Load plan into editor
            function loadPlan(ctx, plan) {
                setVisualData(ctx, plan);
                const editor = ctx === 'input' ? inputEditor : editorEditor;
                const json = JSON.stringify(plan, null, 2);
                editor.setValue(json, -1);
                lastSyncedData[ctx] = json;
                clearUndoHistory(ctx);
                saveUndoState(ctx);
                currentMode[ctx] = 'visual';

                const el = elements[ctx];
                el.tabs?.querySelectorAll('.editor-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === 'visual');
                });
                if (el.visualEditor) el.visualEditor.style.display = 'block';
                if (el.codeEditor) el.codeEditor.classList.remove('active');
            }

            // Get plan from editor
            function getPlan(ctx) {
                if (currentMode[ctx] === 'visual') {
                    return getVisualData(ctx);
                } else {
                    const editor = ctx === 'input' ? inputEditor : editorEditor;
                    try {
                        return JSON.parse(editor.getValue());
                    } catch (e) {
                        return null;
                    }
                }
            }

            // Public API
            return {
                init,
                loadPlan,
                getPlan,
                hasUnsavedChanges,
                clearDraft,
                switchMode,
                getCurrentMode: (ctx) => currentMode[ctx]
            };
        })();

        // =====================
        // Hlavn√≠ inicializace
        // =====================
        function init() {
            // Smazat star√© nekompatibiln√≠ localStorage
            clearOldStorage();

            initMap();
            initAceEditors();

            // Inicializace Visual Editor≈Ø
            VisualEditor.init('input', 'input');
            VisualEditor.init('editor', 'editor');

            setupEventHandlers();

            // 1. Zkontrolovat URL parametry
            const urlPlan = loadFromURL();
            if (urlPlan) {
                const errors = validatePlan(urlPlan);
                if (errors.length === 0) {
                    renderPlan(urlPlan);
                    return;
                } else {
                    // Neplatn√Ω pl√°n v URL - zobrazit modal s chybou
                    inputEditor.setValue(JSON.stringify(urlPlan, null, 2), -1);
                    showErrors(errors, errorSummary, errorList, jsonInputContainer);
                    showModal(inputModal);
                    return;
                }
            }

            // 2. Zkontrolovat localStorage
            const savedPlan = loadPlanFromStorage();
            if (savedPlan) {
                const errors = validatePlan(savedPlan);
                if (errors.length === 0) {
                    // Zobrazit recovery modal
                    const parsed = parseNameWithEmoji(savedPlan.name);
                    document.getElementById('recoveryName').textContent = parsed.name;
                    const totalNights = savedPlan.stops.reduce((sum, s) => sum + calculateNights(s.dateFrom, s.dateTo), 0);
                    document.getElementById('recoveryDetails').textContent =
                        `${savedPlan.stops.length} zast√°vek, ${formatNights(totalNights)}`;
                    showModal(recoveryModal);
                    return;
                }
            }

            // 3. Zobrazit input modal
            showModal(inputModal);
        }

        // Start
        window.addEventListener('load', init);
    })();
    </script>
</body>
</html>
